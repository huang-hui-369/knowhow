[toc]

# sql server backup restore

## sql server backup 種類

* 完全バックアップ
  データベースの完全バックアップでは、データベース全体をバックアップします。 このバックアップにはトランザクション ログの一部が含まれるため、データベースの完全バックアップを復元した後に、データベース全体を復旧することができます。 データベースの完全バックアップは、バックアップが完了した時点でのデータベースを表します。
* 差分バックアップ
  差分バックアップは、直近の完全データ バックアップに基づきます。 差分バックアップでは、その完全バックアップの作成後に変更されたデータのみがキャプチャされます。
* トランザクション ログのバックアップ
  少なくとも 1 つの完全バックアップを作成しておかなければ、ログ バックアップを作成できません。 完全バックアップを作成しておくと、いつでもトランザクション ログをバックアップできます。ただし、そのログのバックアップが既に進行中である場合、バックアップを開始できません。
  作業損失の可能性を最小限に抑え、トランザクション ログを切り捨てられるように、ログ バックアップを頻繁に行うことをお勧めします。

## バックアップすべき

一般的に、データベース管理者は完全バックアップを定期的に (たとえば週 1 回) 作成しますが、必要に応じて短い間隔で (たとえば 1 日 1 回) 差分データベース バックアップを作成します。 データベース バックアップとは別に、トランザクション ログのバックアップを頻繁に作成します。 最適なバックアップ間隔は、バックアップの種類に応じて、データの重要度、データベースのサイズ、サーバーの作業負荷などの要因によって異なります。 

![](img/2021-07-06-16-50-43.png)

![](img/2021-07-06-16-52-14.png)

![](img/2021-07-06-16-52-28.png)

## バックアップ流れ

### 完全バックアップ

1. オブジェクト エクスプローラー で適切な Microsoft SQL Server データベース エンジン のインスタンスに接続した後、サーバー ツリーを展開します。

2. [データベース] を展開し、ユーザー データベースを選択するか、または [システム データベース] を展開してシステム データベースを選択します。

3. バックアップするデータベースを右クリックし、 [タスク] をポイントしてから、 [バックアップ] を選択します。

    ![](img/2021-07-06-16-57-59.png)

4. [データベースのバックアップ] ダイアログボックスで、選択したデータベースがドロップダウン リストに表示されます (これは、サーバー上の他の任意のデータベースに変更できます)。

5. [バックアップの種類] ドロップダウン リストで、バックアップの種類 (既定値は [完全] ) を選択します。
   ![](img/2021-07-06-17-03-59.png)

6. [バックアップ コンポーネント] で [データベース] を選択します。

7. [バックアップ先] セクションで、バックアップ ファイルの既定の場所を確認します (../mssql/data フォルダー内)。

8. [バックアップ先] ドロップダウン リストを使用して、別のデバイスを選択できます。 [追加] を選択して、バックアップ オブジェクトやバックアップ先を追加します。 バックアップの速度を向上させるために、バックアップ セットを複数のファイルにまたがってストライプすることができます。
バックアップ先を削除するには、バックアップ先を選択して [削除] を選択します。 既存のバックアップ先の内容を表示するには、バックアップ先を選択して [内容] を選択します。

スクリプト
```
BACKUP DATABASE [saitama] TO  DISK = N'D:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\Backup\saitama.bak' WITH NOFORMAT, NOINIT,  NAME = N'saitama-完全 データベース バックアップ', SKIP, NOREWIND, NOUNLOAD,  STATS = 10
GO
```

### 差分バックアップ

![](img/2021-07-06-17-19-52.png)

スクリプト
```
BACKUP DATABASE [saitama] TO  DISK = N'D:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\Backup\saitama.bak' WITH  DIFFERENTIAL , NOFORMAT, NOINIT,  NAME = N'saitama-差分 データベース バックアップ', SKIP, NOREWIND, NOUNLOAD,  STATS = 10
GO
```

### トランザクション ログバックアップ

![](img/2021-07-06-17-25-33.png)

```
BACKUP LOG [saitama] TO  DISK = N'D:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\Backup\saitama.bak' WITH NOFORMAT, NOINIT,  NAME = N'saitama-完全 データベース バックアップ', SKIP, NOREWIND, NOUNLOAD,  STATS = 10
GO
```

## 復元流れ

1. オブジェクト エクスプローラー で、 SQL Server データベース エンジン のインスタンスに接続し、そのインスタンスを展開します。

2. [データベース] を右クリックして、 [データベースの復元...] を選択します。
    ![](img/2021-07-06-17-30-38.png)
    ![](img/2021-07-06-17-44-39.png)
    ![](img/2021-07-06-17-44-22.png)

    ![](img/2021-07-06-17-56-28.png)

3. set to mutiuser access
   ![](img/2021-07-06-17-53-19.png)

## 定期バックアップ

スケジュールジョブを作成するために、SQL Server エージェントが必要です。

### SQL Server エージェントの起動

1. SQL Server構成マネージャーを開く。
   ![](img/2021-07-06-18-07-00.png)

2. SQL Server エージェントサービスを起動する。
   ![](img/2021-07-06-18-07-38.png)

3. ssmsを開く。
   ユーザの権限がないと、SQL Server エージェントが表示されない場合があります。
   ![](img/2021-07-06-18-14-59.png)

4. backup をジョブに保存する
   ![](img/2021-07-06-18-17-20.png)

5. 新規ジョブ追加
   ![](img/2021-07-06-18-19-09.png)
   ![](img/2021-07-06-18-20-54.png)

6. 作成したジョブの確認
   ![](img/2021-07-06-18-23-41.png)

# テーブル、プロシージャのsqlスクリプトのエクスポート
1. オブジェクトの選択
    ![](img/2021-07-06-18-32-36.png)
2. オプションの設定
    ![](img/2021-07-06-18-32-08.png)
    ![](img/2021-07-06-18-31-46.png)