# 逻辑存储结构

![image-20211208103416485](D:\github\knowhow\db\mssql\常用概念.assets\image-20211208103416485.png)

SQL Server 将数据库映射为一组操作系统文件。数据和日志信息绝不混合在同一个文件中，而且**一个文件只由一个数据库使用**。文件组是文件的命名集合，用于简化数据存放和管理任务（例如，备份和还原操作）。



## 数据库文件

- 主数据文件（primary file）

  主数据文件是数据库的起点。除了存储系统以及用户数据以外，主数据文件还存储了数据库中的所有辅助数据文件以及重做日志文件的路径、名称、大小等信息。SQL Server通过读取主数据文件得到其他数据文件及重做日志文件的信息，这个功能与Oracle控制文件相似。每个数据库都有只有一个主数据文件。主数据文件的推荐文件扩展名是 .mdf。

  

- 次要数据文件（secondaryfile）

  除主数据文件以外的所有其他数据文件都是次要数据文件，次数据文件一般只存储用户数据。某些数据库可能不含有任何次要数据文件，而有些数据库则含有多个次要数据文件。使用次要数据文件可以扩展存储空间。次要数据文件的推荐文件扩展名是 .ndf。

- 事务日志文件（transactionlog）

  日志文件包含着用于恢复数据库的所有日志信息。每个数据库必须至少有一个日志文件，当然也可以有多个。日志文件的推荐文件扩展名是 .ldf。

## 数据库文件组

为便于分配和管理，可以将数据库对象和文件一起分成文件组。SQL Server的文件组由若干个**数据文件**组成。
  SQL Server的文件组分为primary文件组和用户文件组，分别对应Oracle数据库中的system表空间和用户表空间。

- primary文件组
   主文件组包含主数据文件和任何没有明确分配给其他文件组的其他文件。系统表的所有页均分配在主文件组中。与Oracle数据库的system表空间相似，primary文件组不能删除，其名称primary也是固定不能修改的。
- 用户定义文件组
   用户定义文件组是通过在 CREATE DATABASE 或 ALTER DATABASE 语句中使用 FILEGROUP 关键字指定的任何文件组。

## 数据库文件组优点

- 可以将不同类型的表数据放在不同的文件组上存储，例如，财务数据存放在财务文件组，人力资源数据存放在力资源文件组上。

- 使用文件组可以也就是可以指定将表和索引存储在不同的文件上面，可以提高效率

- 使用文件组来管理文件可以使得同一文件组内的不同文件分布在不同的硬盘中，极大的提高了IO性能.一般计算机中IO为性能瓶颈。

  例如 人员表存放在人员文件组，人员文件组有两个文件，分别存放在两块磁盘上， 可以通过分区函数，将人员序号为奇数的数据存放在磁盘1上，将人员序号为奇数的数据存放在磁盘2上，这样的话访问数据时，可以同时访问两块硬盘，提高了IO性能.。

  

## **页**（**Page**）

 与书籍类似，SQL Server 所有数据行都写在页面上。 书中的所有页都具有相同的物理大小。 同样，SQL Server 所有数据页大小均相同  8 KB。

SQL Server 中数据存储的基本单位是页。SQL Server会将数据库中的数据文件（.mdf 或 .ndf）从逻辑上划分成n页（从 0 到 n 连续编号）。 磁盘 I/O 操作在页级执行。 也就是说，SQL Server 读取或写入所有数据页。

与书籍类似 SQL Server页有数据，索引，目录

- 数据页    	  存储的实际数据行

- Text/Image    大型对象数据类型：（text、ntext、image、nvarchar(max)、varchar(max)、varbinary(max) 和 xml 数据）

- 索引页           存储的索引条目

- 系统页            存储各种元数据（PFS、GAM、SGAM、IAM、DCM、BCM 页）

  

### 页的结构

![image-20211208152246965](D:\github\knowhow\db\mssql\常用概念.assets\image-20211208152246965.png)

- 标头      96 字节的标头，用于存储有关页的系统信息。 此信息包括页码、页类型、页的可用空间以及拥有该页的对象的分配单元 ID。
- 数据行   紧接着标头按顺序放置
- 偏移表    页的末尾是行偏移表，对于页中的每一行，每个行偏移表都包含一个条目。每个行偏移量条目记录**对应行**的第一个字节与页首的距离，因此，行偏移量的功能有助于 SQL Server 快速在页面上定位行。 行偏移表中的条目的顺序与页中行的顺序相反。

### 大型行支持

### 行溢出

## 区

一个区是八个物理上连续的页（即 64 KB）。

- 统一盘区    由单个对象所有。盘区中的所有八页只能由所属对象使用。

- 混合盘区，最多可由八个对象共享。 区中八页的每页可由不同的对象所有。

  ![image-20211208152923823](D:\github\knowhow\db\mssql\常用概念.assets\image-20211208152923823.png)

### 管理区分配

- 全局分配映射表 (GAM)

  GAM 页记录已分配的区。 每个 GAM 包含 64,000 个区，相当于近 4 GB 的数据。 GAM 用 1 个位来表示所涵盖区间内的每个区的状态。 如果位为 1，则区可用；如果位为 0，则区已分配。

- 共享全局分配映射表 (SGAM)

  SGAM 页记录当前用作混合区且至少有一个未使用的页的区。 每个 SGAM 包含 64,000 个区，相当于近 4-GB 的数据。 SGAM 用 1 个位来表示所涵盖区间内的每个区的状态。 如果位为 1，则区正用作混合区且有可用页。 如果位为 0，则区未用作混合区，或者虽然用作混合区但其所有页均在使用中。

这将简化区管理算法。

- 若要分配统一区，SQL Server 数据库引擎将搜索 GAM 以查找为 1 的位并将其设置为 0。
- 为了查找具有可用页的混合区，SQL Server 数据库引擎搜索 SGAM 以查找为 1 的位。
- 若要分配混合区，SQL Server 数据库引擎在 GAM 中搜索为 1 的位，并将其设置为 0；然后将 SGAM 中的对应位设置为 1。
- 若取消分配某个区，SQL Server 数据库引擎确保 GAM 位设置为 1，而 SGAM 位设置为 0。 SQL Server 数据库引擎 在内部实际使用的算法比本文介绍的内容更复杂，因为 SQL Server 数据库引擎 在数据库中平均分布数据。 但是，由于无需管理区分配信息链，因此即使是实际算法也会被简化。

### 跟踪可用空间

“页可用空间 (PFS)”页记录每页的分配状态，是否已分配单个页以及每页的可用空间量。 PFS 对每页都有 1 个字节，记录该页是否已分配。如果已分配，则记录该页是为空、已满 1% 到 50%、已满 51% 到 80%、已满 81% 到 95% 还是已满 96% 到 100%。

它将在数据文件中按各自的区域间隔添加一个新的 PFS、GAM 或 SGAM 页面。 因此，将出现一个新的 PFS 页面，在第一个 PFS 页面之后为 8,088 页，在间隔 8,088 页后为另一个 PFS 页面。 举例说明，第 1 页为 PFS 页面，第 8088 页为 PFS 页面，第 16176 页为 PFS 页面，以此类推。 也将出现一个新的 GAM 页面，在第一个 GAM 页面之后为 64,000 区，在间隔 64,000 区后为另一个 GAM 页面，以此类推。 同样，将出现一个新的 SGAM 页面，在第一个 SGAM 页面之后为 64,000 区，在间隔 64,000 区后为另一个 SGAM 页面。 下图显示了SQL Server 数据库引擎用来分配和管理区的页顺序。

![image-20211208160710252](D:\github\knowhow\db\mssql\常用概念.assets\image-20211208160710252.png)

### 管理对象使用的空间

索引分配映射 (IAM)”页将映射分配单元使用的数据库文件中 4-GB 部分中的盘区。 分配单元有下列三种类型：

- IN_ROW_DATA
  用于存储堆分区或索引分区。
- LOB_DATA
  包含大型对象 (LOB) 数据类型，如 XML、VARBINARY(max) 和 VARCHAR(max)。
- ROW_OVERFLOW_DATA
  包含超过 8,060 字节行大小限制的 VARCHAR、NVARCHAR、VARBINARY 或 SQL_VARIANT 列中存储的可变长度数据。

堆或索引的每个分区至少包含一个 IN_ROW_DATA 分配单元。 根据堆或索引的架构，可能还包含一个 LOB_DATA 或 ROW_OVERFLOW_DATA 分配单元。

一个 IAM 页在文件中的范围为 4 GB，与 GAM 或 SGAM 页的范围相同。 如果分配单元包含来自多个文件的区，或者超过一个文件的 4 GB 范围，那么一个 IAM 链中将链接多个 IAM 页。 因此，每个分配单元在有区的每个文件中至少有一个 IAM 页。 如果分配给分配单元的文件中的区的范围超过了一个 IAM 页能够记录的范围，一个文件中也可能会有多个 IAM 页。

![iam_pages](D:\github\knowhow\db\mssql\常用概念.assets\iam-pages.gif)

IAM 页根据需要分配给每个分配单元，在文件中的位置也是随机的。 `sys.system_internals_allocation_units` 系统视图指向分配单元的第一个 IAM 页。 该分配单元的所有 IAM 页都链接到一个 IAM 链中。

![iam_chain](D:\github\knowhow\db\mssql\常用概念.assets\iam-chain.gif)

每个分配单元的链中所链接的 IAM 页 IAM 页有一个标头，指明 IAM 页所映射的区范围的起始区。 IAM 页中还有一个大位图，其中每个位代表一个区。 位图中的第一个位代表范围内的第一个区，第二个位代表第二个区，依此类推。 如果某个位是 0，它所代表的区将不会分配给拥有该 IAM 页的分配单元。 如果这个位是 1，它所代表的区将被分配给拥有该 IAM 页的分配单元。

当 SQL Server 数据库引擎必须在当前页中插入新行，而当前页中没有可用空间时，它将使用 IAM 和 PFS 页查找要将该行分配到的页，或者（对于堆或 Text/Image 页）查找具有足够空间容纳该行的页。 SQL Server 数据库引擎使用 IAM 页查找分配给分配单元的区。 对于每个区，SQL Server 数据库引擎将搜索 PFS 页，以查看是否有可用的页。 每个 IAM 和 PFS 页覆盖大量数据页，因此一个数据库内只有很少的 IAM 和 PFS 页。 这意味着 IAM 和 PFS 页通常位于内存中的 SQL Server 缓冲池中，所以能够很快找到它们。 对于索引，新行的插入点由索引键设置，但是当需要新页面时，将发生先前描述的过程。

仅当 SQL Server 数据库引擎不能在现有的区中快速找到足以容纳插入行的页时，才将新区分配给分配单元。

SQL Server 数据库引擎 使用“比例填充分配算法”从文件组的可用盘区中分配盘区。 如果同一文件组内有两个文件，而一个文件的可用空间是另一个文件的两倍，那么每从后一个文件分配一页，就从前一个文件分配两页。 这意味着文件组内的每个文件应该有近似的空间使用百分比。

## 跟踪已修改的区

SQL Server 使用两个内部数据结构跟踪被大容量复制操作修改的盘区，以及自上次完整备份后修改的盘区。 这些数据结构极大地加快了差异备份的速度。 当数据库使用大容量日志恢复模式时，这些数据结构也可以加快将大容量复制操作记录至日志的速度。 与全局分配图 (GAM) 和共享全局分配图 (SGAM) 页相同，这些结构也是位图，其中的每一位代表一个单独的区。

- 差异更改映射表 (DCM)
  这样便可跟踪自上次执行 `BACKUP DATABASE` 语句后更改过的盘区。 如果扩展盘区的位是 1，则自上次执行 `BACKUP DATABASE` 语句后扩展盘区已被修改。 如果位是 0，则扩展盘区没有被修改。 差异备份只读取 DCM 页便可以确定已修改的区。 这样大大减少了差异备份必须扫描的页数。 运行差异备份所需的时间与自上次执行 BACKUP DATABASE 语句之后修改的区数成正比，而不是与整个数据库的大小成正比。
- 大容量更改映射表 (BCM)
  跟踪自上次执行 `BACKUP LOG` 语句后，被大容量日志记录操作修改的盘区。 如果某个扩展盘区的位是 1，表明自上次执行 `BACKUP LOG` 语句后，该扩展盘区已经被有日志记录的大容量复制操作修改。 如果位是 0，则该扩展盘区未被有日志记录的大容量复制操作修改。 尽管所有数据库中都显示 BCM 页，但只有在数据库使用大容量日志记录恢复模式时，才会与 BCM 页有关。 在此恢复模式中，当执行 `BACKUP LOG` 时，备份进程将扫描 BCM 查找已经修改的盘区。 然后，将那些区包括在日志备份中。 如果数据库从数据库备份和一系列事务日志备份恢复，便可以恢复大容量日志记录操作。 在使用简单恢复模式的数据库中，BCM 页是不相关的，因为大容量日志记录操作不记入日志。 在使用完整恢复模式的数据库中，BCM 页同样不相关，因为该恢复模式将大容量日志记录操作视为有完整日志记录的操作。

DCM 页和 BCM 页的间隔与 GAM 和 SGAM 页的间隔相同，都是 64,000 个区。 在物理文件中，DCM 和 BCM 页位于 GAM 和 SGAM 页之后。

![special_page_order](D:\github\knowhow\db\mssql\常用概念.assets\special-page-order.gif)



## 堆

## B TREE





## 分区表



## 聚集表

# 统计信息



# 用户，Role，权限





